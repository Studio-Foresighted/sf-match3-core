<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Artworx Alchemy</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lilita+One&display=swap" rel="stylesheet">
    <style>
      @import url(https://fonts.googleapis.com/css?family=Lato:100,300,400,700);

      html, body {
        height: 100%;
        margin: 0;
        overflow: hidden; /* Prevent scrollbars */
        touch-action: none; /* Prevent scrolling on mobile */
      }
      body {
        font-family: 'Lilita One', sans-serif;
        background: linear-gradient(to bottom, rgba(0,0,0,1) 0%,rgba(17,17,17,1) 100%);
        text-shadow: -2px 2px black, 0 1px black, 1px 0 black, 0 -1px black;
      }

      /* --- LOADING BAR --- */
      .loader {
        height: 40px;
        width: 90%; /* Full width on mobile (with margin.) */
        max-width: 1080px; /* Max size 1080px */
        border: 2px solid #666;
        border-radius: 20px;
        position: absolute; 
        top: 0; bottom: 0; left: 0; right: 0;
        margin: auto;
        font-weight: 300; 
        font-size: 22px;
        z-index: 9999;
        transition: opacity 0.5s ease-out;
        opacity: 0;
        /* New Font Style */
        font-family: 'Lilita One', sans-serif;
        color: white;
        -webkit-text-stroke: 1px black;
        text-shadow: 2px 2px 0 #000;
      }
      .loader:after {
        content: "";
        display: block;
        width: 100%;
        height: 100%;
        background: linear-gradient(to bottom, rgba(255,255,255,0) 0%,rgba(255,255,255,0.2) 50%,rgba(255,255,255,0) 100%);
        position: absolute;
        top: 0;
        left: 0;
      }
      .track {
        width: 100%;
        height: 100%;
        border-radius: 20px;
        color: #000;
        text-align: center;
        line-height: 40px;
        overflow: hidden;
        position: relative;
        opacity: 1;
        background: #ffffff !important; /* Solid White */
      }
      .glow {
        width: 0%;
        height: 100%;
        background: linear-gradient(to bottom, #ccff00 0%, #00ff00 100%); /* Ultra Bright Neon Green */
        box-shadow: 0px 0px 25px 5px #00ff00; /* Stronger, brighter glow */
        position: absolute;
        top: 0;
        left: 0;
        animation: flicker 5s infinite;
        overflow: hidden;
        z-index: 5;
      }
      .underglow {
        width: 0%;
        height: 0%; 
        border-radius: 20px;
        box-shadow: 0px 0px 80px 15px #00ff00; /* Massive bright underglow */
        position: absolute;
        bottom: -5px;
        animation: flicker 5s infinite;
        z-index: 1;
      }
      .front {
        display: none; /* Remove the moving text inside the glow */
      }
      .back {
        color: #ffffff; /* White text */
        text-shadow: 2px 2px 0px #000000; /* Black drop shadow */
        position: absolute;
        width: 100%;
        left: 0;
        top: 0;
        z-index: 10; /* Ensure it's above the glow */
        font-weight: 900; /* Extra Bold */
        font-size: 26px; /* Bigger */
        letter-spacing: 4px; /* Stylized spacing */
      }

      /* --- REMOVED INIT OVERLAY --- */
      #sc-init-overlay {
        display: none !important;
      }

      @keyframes flicker {
        10% { opacity: 0.9; }
        30% { opacity: 0.86; }
        60% { opacity: 0.8; }
        80% { opacity: 0.75; }
      }

      /* --- MUTE BUTTON --- */
      .toggle-sound {
        position: fixed;
        background-color: #EC407A;
        width: 55px;
        height: 55px;
        line-height: 55px;
        text-align: center;
        color: #fff;
        border-radius: 50%;
        cursor: pointer;
        z-index: 9999;
        animation: pulse 1.25s infinite cubic-bezier(0.66, 0, 0, 1);
        box-shadow: 0 0 0 0 #F06292;
        display: none; /* Hidden by default */
        transition: transform 0.3s ease;
      }

      /* Mobile: Top Right */
      /* MOVED TO BOTTOM OF STYLE BLOCK FOR SPECIFICITY */

      /* Desktop: Below Video (Positioned via JS) */
      @media (min-width: 769px) {
        .toggle-sound {
          transform: scale(2); /* Twice as large */
          transform-origin: center;
        }
      }

      .toggle-sound.sound-mute {
        box-shadow: none;
        animation: none;
        background-color: #999; /* Grey out when muted? Or keep pink? Design says just remove shadow */
      }
      @-webkit-keyframes pulse {to {box-shadow: 0 0 0 45px rgba(232, 76, 61, 0);}}
      @-moz-keyframes pulse {to {box-shadow: 0 0 0 45px rgba(232, 76, 61, 0);}}
      @-ms-keyframes pulse {to {box-shadow: 0 0 0 45px rgba(232, 76, 61, 0);}}
      @keyframes pulse {to {box-shadow: 0 0 0 45px rgba(232, 76, 61, 0);}}

      .sound {
        width: 97%;
        height: 100%;
        position: absolute;
        cursor: pointer;
        display: inline-block;
        left: 0;
        top: 0;
        margin-left: -15%;
      }
      .sound--icon {
        color: inherit;
        line-height: inherit;
        font-size: 1.6rem;
        display: block;
        margin: auto;
        text-align: left;
        padding-left: 20px;
      }
      .sound--wave {
        position: absolute;
        border: 2px solid transparent;
        border-right: 2px solid #fff;
        border-radius: 50%;
        transition: all 200ms;
        margin: auto;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
      }
      .sound--wave_one { width: 45%; height: 40%; }
      .sound--wave_two { width: 70%; height: 62%; }
      .sound--wave_three { width: 95%; height: 75%; }
      
      .sound-mute .sound--wave {
        border-radius: 0;
        width: 35%;
        height: 35%;
        border-width: 0 2px 0 0;
        left: 5px;
      }
      .sound-mute .sound--wave_one { transform: rotate(45deg) translate3d(0, -50%, 0); }
      .sound-mute .sound--wave_two { transform: rotate(-45deg) translate3d(0, 50%, 0); }
      .sound-mute .sound--wave_three { opacity: 0; transform: translateX(-46%); height: 20%; }

      /* --- CHARACTER SELECTION --- */
      #character-selection {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        flex-direction: column;
      }

      /* Container to handle the scaling */
      .cs-card-container {
        position: relative;
        /* Default Mobile Scale - Reduced by ~10% from 1.2 to 1.08 */
        transform: scale(1.08);
      }

      /* Desktop Scale: Fixed large scale */
      @media (min-width: 768px) {
        .cs-card-container {
          transform: scale(1.8);
        }
      }

      /* Safety for shorter screens */
      @media (min-width: 768px) and (max-height: 850px) {
        .cs-card-container {
          transform: scale(1.5);
        }
      }

      .cs-card {
        position: relative;
        cursor: pointer;
        font-family: "Roboto", sans-serif;
        color: #fff;
        /* Automatic Breathing Animation */
        animation: card-breathe 3s ease-in-out infinite;
        /* Ensure button stays below */
        margin-bottom: 20px;
      }

      @keyframes card-breathe {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
      }

      .cs-card__character {
        width: 200px;
        position: absolute;
        top: -7em;
        margin-left: 2em;
        z-index: 9;
        filter: drop-shadow(0px 17px 22px rgba(0, 0, 0, 0.1));
        /* Automatic Character Float Animation */
        animation: char-float 3s ease-in-out infinite;
      }

      @keyframes char-float {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
      }

      .cs-card__character::before {
        content: "";
        visibility: visible;
        box-sizing: border-box;
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center bottom;
        display: inline-block;
        height: 300px;
        width: 250px;
        background-image: url('/assets/red-alchemist-jump-skirt-nowhite5.png');
      }

      .cs-card__shape {
        width: 257.3px;
        height: 131px;
        background-color: #d32f2f;
        margin-left: 1.25em;
        transform: skewX(0deg) skewY(-19deg) scale(1.15);
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
      }

      .cs-card__detail {
        padding: 1.5em;
        width: 248.3px;
        position: absolute;
        top: 81.5px;
        background-color: #d32f2f;
        border-bottom-left-radius: 25px;
        border-bottom-right-radius: 25px;
      }

      .cs-card__detail::before {
        content: "";
        opacity: 0.2;
        width: 30px;
        height: 330px;
        position: absolute;
        top: -7em;
        right: -15px;
        border-radius: 30px;
        background-color: #d32f2f;
      }

      .cs-card__detail__name h1 {
        letter-spacing: 1px;
        margin-top: 2.5em;
        margin-bottom: 0;
        font-family: "Lilita One", cursive; /* Changed from Bangers to match Click to Start */
        color: white;
      }

      .cs-card__detail__rate {
        display: flex;
        align-items: center;
      }

      .cs-card__detail__rate img {
        width: 90px;
        height: 13px;
        margin-right: 15px;
      }

      .cs-card__detail__rate p {
        color: #fff;
        font-size: 12px;
        margin: 0;
      }

      .cs-card__detail__statistics {
        margin-top: 1.5em;
        display: flex;
        align-items: center;
      }

      .cs-card__detail__statistics-bag {
        padding: 5px;
        border: 1px solid #ffffff63;
        border-radius: 4px;
        margin-right: 10px;
        display: flex;
        align-items: flex-end;
      }

      .cs-card__detail__statistics-bag span {
        margin-right: 10px;
      }

      .cs-card__detail__statistics-bag span label {
        font-size: 10px;
        display: block;
      }

      .cs-card__detail__statistics-bag span p {
        margin: 0;
        font-size: 13px;
      }

      .cs-card__detail__statistics-bag img {
        width: 25px;
        height: 25px;
      }

      .cs-card__logo {
        opacity: 0.2;
        position: absolute;
        right: 0em;
        bottom: 6em;
      }

      .cs-card__logo img {
        width: 150px;
        filter: brightness(0) invert(1);
      }

      #cs-select-btn {
        padding: 8px 20px;
        font-family: "Lilita One", cursive; /* Changed from Bangers to match Click to Start */
        font-size: 20px;
        color: #d32f2f;
        background: #fff;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s;
        letter-spacing: 1px;
        margin-left: 10px;
        flex-grow: 1; /* Fill remaining space */
        text-align: center;
      }

      #cs-select-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        background-color: #ffebee;
      }

      /* --- SUPERCELL UI --- */
      #sc-hud {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none; /* Let clicks pass through to game */
        display: none; /* Hidden by default */
        z-index: 5000;
      }

      .sc-top-bar {
        position: absolute;
        /* Positioned by JS */
        height: 0;
        pointer-events: none;
      }

      /* Score: Top Left of Board */
      .sc-stat-box-score {
        position: absolute;
        bottom: 20px; /* Position above the board top edge */
        left: -20px;
        height: 45px;
        min-width: 150px;
        background-color: #000000;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: row;
        transform: skewX(-9deg) scale(2.0); /* x2 Size */
        transform-origin: bottom right; /* Grow outwards to the left */
        padding: 0 15px;
        border: 2px solid #333;
        border-radius: 4px;
        pointer-events: auto;
      }

      /* Moves: Top Right of Board */
      .sc-stat-box-moves {
        position: absolute;
        bottom: 20px;
        right: -20px;
        height: 45px;
        min-width: 150px;
        background-color: #000000;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: row;
        transform: skewX(-9deg) scale(2.0); /* x2 Size */
        transform-origin: bottom left; /* Grow outwards to the right */
        padding: 0 15px;
        border: 2px solid #333;
        border-radius: 4px;
        pointer-events: auto;
        z-index: 10; /* Ensure above video */
      }

      /* --- CHARACTER VIDEO --- */
      #sc-character-container {
        position: absolute;
        bottom: 55px; /* Sit on top of moves bar */
        right: -140px; /* Align with moves bar which extends far right */
        width: fit-content; /* Wrap content for grid */
        height: 380px; /* Increased size */
        border: 4px solid #333;
        border-radius: 12px;
        background: transparent; /* Transparent to avoid black flash */
        overflow: hidden;
        /* No skew */
        z-index: 5; 
        pointer-events: auto;
        box-shadow: 0 6px 15px rgba(0,0,0,0.6);
        transition: all 0.3s ease;
        display: grid; /* Grid for stacking */
        grid-template-areas: "stack";
      }

      .sc-video-layer {
        grid-area: stack;
        width: auto;
        height: 100%;
        transform: scaleX(-1); /* Flip horizontally */
        display: block;
        opacity: 0;
      }

      .sc-video-layer.active {
        opacity: 1;
        z-index: 2;
      }

      /* Circle Mode Overrides (Toggled via JS) */
      .sc-video-circle {
        width: 380px !important; /* Force square for circle */
        border-radius: 50% !important;
      }
      .sc-video-circle .sc-video-layer {
        width: 100% !important;
        object-fit: cover !important;
      }

      @media (max-width: 768px) {
        #sc-character-container {
            width: fit-content;
            height: 200px;
            bottom: 50px;
            right: -60px;
            border-width: 2px;
        }
        /* Mobile Circle Override */
        .sc-video-circle {
            width: 200px !important;
        }
      }

      .sc-stat-icon {
        height: 48px;
        position: absolute;
        left: -20px;
        top: -8px;
        filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.5));
      }

      .sc-stat-text {
        color: white;
        text-align: center;
        margin-left: 20px;
        font-size: 24px;
        line-height: 45px;
      }

      .sc-menu-btn {
        position: absolute;
        top: 20px; /* Top of screen */
        right: 20px; /* Right of screen */
        cursor: pointer;
        width: 60px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(180deg, #343c50 63%, #38545f 100%);
        transition: 0.2s;
        box-shadow: 0px 4px 0 #00000047;
        transform: scale(1.5) skewX(-9deg); /* 1.5x size */
        transform-origin: top right;
        border-radius: 5px;
        border: 1px solid #050E25;
        pointer-events: auto;
        z-index: 6000;
      }

      .sc-menu-btn:before {
        content: "";
        position: absolute;
        left: 0; right: 0; top: 0;
        z-index: 200;
        background-color: #5A5371;
        height: 3px;
        border-top-left-radius: 4px;
        border-top-right-radius: 4px;
      }

      .sc-menu-btn:after {
        content: "";
        position: absolute;
        left: 0; right: 0; bottom: 0;
        z-index: 200;
        background-color: #252C3C;
        height: 3px;
        border-bottom-left-radius: 4px;
        border-bottom-right-radius: 4px;
      }

      .sc-menu-btn:active {
        transform: scale(1.4) skewX(-9deg); /* Slightly smaller on click */
      }

      .sc-menu-icon {
        height: 24px;
        position: relative;
        z-index: 300;
        transform: skewX(9deg); /* Unskew icon */
      }

      /* --- STAR RATING --- */
      :root {
        --star-yellow: #f2b01e;
        --star-inactive: #444;
      }

      .sc-star-bar {
        position: absolute;
        bottom: 140px; /* Moved up more */
        left: -20px; /* Aligned with score */
        display: flex;
        align-items: center;
        gap: 2px;
        pointer-events: auto;
        transform: skewX(-9deg) scale(2.25); /* 1.5x bigger */
        transform-origin: bottom right; /* Match score origin */
        background: rgba(0,0,0,0.6);
        padding: 0 15px;
        border-radius: 20px;
        border: 2px solid #333;
        height: 24px; /* Thin bar */
      }

      .sc-star-connector {
        width: 20px;
        height: 6px;
        background-color: var(--star-inactive);
        border-radius: 3px;
        margin: 0 -2px;
        position: relative;
        z-index: 1;
      }

      .sc-star-connector.active {
        background-color: var(--star-yellow);
        box-shadow: 0 0 8px var(--star-yellow);
        transition: background-color 0.3s ease;
      }

      .sc-star {
        width: 40px;
        height: 40px;
        position: relative;
        filter: drop-shadow(0 4px 0 rgba(0,0,0,0.5));
        z-index: 2;
        margin-top: -2px; /* Center vertically on the thin bar */
      }

      /* --- WIN SCREEN OVERLAY --- */
      #sc-win-screen {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: radial-gradient(circle, rgba(49,190,234,0.9) 0%, rgba(5,14,37,0.95) 100%);
        z-index: 9999;
        display: none; /* Hidden by default */
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-family: 'Lilita One', sans-serif;
        animation: fadeIn 0.5s ease-out;
        overflow: hidden;
      }

      #sc-win-canvas {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none;
        z-index: -1;
      }

      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

      .sc-win-title {
        font-size: 120px; /* Bigger */
        color: #f2b01e;
        text-transform: uppercase;
        -webkit-text-stroke: 4px #000;
        text-shadow: 0 12px 0 #000;
        margin-bottom: 40px;
        transform: skewX(-5deg) rotate(-3deg);
        animation: titlePop 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        z-index: 10;
      }

      @media (max-width: 600px) {
        .sc-win-title { font-size: 60px; -webkit-text-stroke: 2px #000; text-shadow: 0 6px 0 #000; }
        .sc-win-star { width: 80px !important; height: 80px !important; }
        .sc-win-btn { font-size: 24px !important; padding: 10px 30px !important; }
      }

      @keyframes titlePop { 0% { transform: scale(0); } 100% { transform: skewX(-5deg) rotate(-3deg) scale(1); } }

      .sc-win-stars {
        display: flex;
        gap: 30px;
        margin-bottom: 60px;
        z-index: 10;
      }

      .sc-win-star {
        width: 150px; /* Bigger */
        height: 150px;
        opacity: 0;
        transform: scale(0);
      }

      .sc-win-star.pop {
        animation: starPop 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
      }

      @keyframes starPop { to { opacity: 1; transform: scale(1); } }

      .sc-win-btn {
        background: linear-gradient(to bottom, #f2b01e 0%, #e69b00 100%);
        border: 4px solid #000;
        border-bottom-width: 8px;
        border-radius: 10px;
        padding: 20px 60px;
        font-size: 40px;
        color: #fff;
        text-shadow: 2px 2px 0 #000;
        cursor: pointer;
        transform: skewX(-5deg);
        transition: transform 0.1s;
        text-transform: uppercase;
        font-weight: bold;
        z-index: 10;
      }

      .sc-win-btn:active {
        transform: skewX(-5deg) translateY(4px);
        border-bottom-width: 4px;
      }

      .sc-win-btn:hover {
        filter: brightness(1.1);
      }

      .sc-star svg {
        width: 100%;
        height: 100%;
        display: block;
        overflow: visible;
      }

      .sc-star-ring, .sc-star-fill, .sc-star-line, .sc-star-stroke {
        animation-duration: 1s;
        animation-timing-function: ease-in-out;
        animation-fill-mode: forwards;
        transform-origin: center;
      }

      .sc-star-ring, .sc-star-fill, .sc-star-line {
        stroke: var(--star-yellow);
      }

      .sc-star-fill {
        fill: var(--star-yellow);
        transform: scale(0);
      }

      .sc-star-line {
        stroke-dasharray: 12 13;
        stroke-dashoffset: -13;
      }

      .sc-star-stroke {
        stroke: #666;
        stroke-width: 2;
        fill: none;
        transition: stroke 0.3s;
      }

      /* Active State */
      .sc-star.active .sc-star-stroke {
        stroke: var(--star-yellow);
        animation-name: starStroke;
      }
      .sc-star.active .sc-star-ring { animation-name: starRing; }
      .sc-star.active .sc-star-fill { animation-name: starFill; }
      .sc-star.active .sc-star-line { animation-name: starLine; }

      @keyframes starRing {
        from, 20% { opacity: 1; r: 8px; stroke-width: 16px; transform: scale(0); }
        35% { opacity: 0.5; r: 8px; stroke-width: 16px; transform: scale(1); }
        50%, to { opacity: 0; r: 16px; stroke-width: 0; transform: scale(1); }
      }
      @keyframes starFill {
        from, 40% { transform: scale(0); }
        60% { transform: scale(1.2); }
        80% { transform: scale(0.9); }
        to { transform: scale(1); }
      }
      @keyframes starStroke {
        from { transform: scale(1); }
        20%, to { transform: scale(0); }
      }
      @keyframes starLine {
        from, 40% { stroke-dasharray: 1 23; stroke-dashoffset: 1; }
        60%, to { stroke-dasharray: 12 13; stroke-dashoffset: -13; }
      }

      /* --- PAUSE MENU --- */
      #sc-pause-menu {
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 6000;
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      }

      .sc-menu-panel {
        background: #bafff7;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
        text-align: center;
        min-width: 300px;
        border: 4px solid #000;
        background-image: url('https://github.com/raharisonAina/BrawlStars/blob/main/assets/bg-pattern-on-green.png?raw=true');
      }

      @media (max-width: 768px) {
        .sc-menu-panel {
            width: 90%;
            min-width: auto;
        }
      }

      .sc-menu-title {
        font-size: 32px;
        color: #fff;
        margin-bottom: 20px;
        -webkit-text-stroke: 1px black;
      }

      .sc-menu-option {
        background: #EEC308;
        border: 2px solid black;
        padding: 10px 20px;
        margin: 10px 0;
        font-size: 20px;
        color: white;
        cursor: pointer;
        transform: skewX(-9deg);
        transition: transform 0.1s, filter 0.2s;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }
      
      .sc-menu-option:hover {
        transform: scale(1.05) skewX(-9deg);
      }

      .sc-menu-option.btn-resume {
        background: #4CAF50; /* Green */
        font-size: 28px; /* Bigger */
        padding: 15px 30px;
        border-width: 3px;
      }
      .sc-menu-option.btn-resume:before { background-color: #81C784; }
      .sc-menu-option.btn-resume:after { background-color: #388E3C; }

      .sc-menu-option.btn-quit {
        background: #F44336; /* Red */
      }
      .sc-menu-option.btn-quit:before { background-color: #E57373; }
      .sc-menu-option.btn-quit:after { background-color: #D32F2F; }

      .sc-menu-option.grey {
        background: #9E9E9E;
        border-color: #616161;
      }
      .sc-menu-option.grey:before { background-color: #BDBDBD; }
      .sc-menu-option.grey:after { background-color: #757575; }

      .sc-menu-option:before {
        content: "";
        position: absolute;
        left: 0; right: 0; top: 0;
        background-color: #FBEF43;
        height: 4px;
      }
      .sc-menu-option:after {
        content: "";
        position: absolute;
        left: 0; right: 0; bottom: 0;
        background-color: #A5532D;
        height: 4px;
      }

      /* Confirmation Modal */
      #sc-confirm-modal {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85);
        z-index: 7000;
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      }
      .sc-confirm-box {
        background: #fff;
        padding: 30px;
        border-radius: 10px;
        text-align: center;
        border: 4px solid #000;
        max-width: 300px;
      }
      .sc-confirm-text {
        font-size: 24px;
        margin-bottom: 20px;
        color: #000;
      }
      .sc-confirm-actions {
        display: flex;
        gap: 20px;
        justify-content: center;
      }
      .sc-btn-yes {
        background: #4CAF50;
        color: white;
        border: 2px solid #000;
        padding: 10px 20px;
        font-size: 20px;
        cursor: pointer;
        transform: skewX(-5deg);
      }
      .sc-btn-no {
        background: #F44336;
        color: white;
        border: 2px solid #000;
        padding: 10px 20px;
        font-size: 20px;
        cursor: pointer;
        transform: skewX(-5deg);
      }

      /* --- INITIAL PLAY OVERLAY --- */
      #sc-init-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 10000;
        display: none; /* Hidden by default, shown via JS */
        align-items: center;
        justify-content: center;
      }
      #sc-init-btn {
        background: linear-gradient(to bottom, #f2b01e 0%, #e69b00 100%);
        border: 4px solid #000;
        border-bottom-width: 8px;
        border-radius: 50%;
        width: 120px;
        height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: transform 0.1s;
        box-shadow: 0 0 30px rgba(242, 176, 30, 0.6);
      }
      #sc-init-btn:active {
        transform: translateY(4px);
        border-bottom-width: 4px;
      }
      #sc-init-btn i {
        font-size: 50px;
        color: #fff;
        text-shadow: 2px 2px 0 #000;
        margin-left: 8px; /* Optical center */
      }

      /* Mobile: Top Right - MOVED TO BOTTOM FOR SPECIFICITY */
      @media (max-width: 768px) {
        .toggle-sound {
          top: 20px;
          right: 20px;
          transform: scale(1);
        }
        
        /* Mobile Video Adjustment */
        #sc-intro-video {
          object-fit: cover;
          width: 100%;
          height: 100%;
        }

        /* Mobile UI Adjustments */
        .sc-stat-box-score, .sc-stat-box-moves {
          transform: skewX(-9deg);
          width: 18%; /* Half of 30% approx, slightly larger for text safety */
          min-width: auto;
          height: 30px; /* Slightly shorter */
          bottom: 10px;
          padding-left: 5px;
          padding-right: 5px;
          justify-content: flex-start; /* Align content left */
        }
        
        /* Align next to each other on the left */
        .sc-stat-box-score { 
          left: 10px; 
        }
        .sc-stat-box-moves { 
          left: calc(10px + 18% + 10px); /* Left + Width + Gap */
          right: auto; /* Reset right */
        }

        .sc-stat-text {
          font-size: 12px; /* Smaller font */
          line-height: 30px;
          margin-left: 25px; /* Space for icon */
        }

        .sc-stat-icon {
          height: 25px; /* Smaller icon */
          top: -2px;
          left: -5px;
        }

        /* Stars Bar: Align on the right (where moves used to be) */
        .sc-star-bar {
          transform: skewX(-9deg) scale(0.9);
          bottom: 10px;
          right: 10px;
          left: auto; /* Reset left */
          transform-origin: bottom right;
          z-index: 20; /* Above avatar */
        }

        /* Avatar: Hug Top Right */
        #sc-character-container {
            top: 0; /* Below menu button (approx) */
            right: 0; /* Hug right edge */
            transform: scale(0.7); /* Scale down slightly */
            transform-origin: top right;
        }

        .sc-menu-btn {
          transform: scale(1.0) skewX(-9deg);
          top: 0;
          right: 5px;
          z-index: 6001; /* Ensure above everything */
        }
      }

    </style>
  </head>
  <body>
    <div id="sc-init-overlay">
        <div id="sc-init-btn">
            <i class="fa fa-play"></i>
        </div>
    </div>

    <div class="loader" id="appLoader">
      <div class="track">
        <div class="glow" id="loaderGlow">
          <div class="front">LOADING</div>
        </div>
        <span class="back">LOADING</span>
      </div>
      <div class="underglow" id="loaderUnderglow"></div>
    </div>

    <div class="toggle-sound" id="muteBtn">
      <div class="tooltip--left sound" data-tooltip="Turn On/Off Sound">
        <div class="sound--icon fa fa-volume-off"></div>
        <div class="sound--wave sound--wave_one"></div>
        <div class="sound--wave sound--wave_two"></div>
        <div class="sound--wave sound--wave_three"></div>
      </div>
    </div>

    <!-- Character Selection Screen -->
    <div id="character-selection">
      <div class="cs-card-container">
        <div class="cs-card">
          <div class="cs-card__character"></div>
          <div class="cs-card__shape"></div>
          <div class="cs-card__detail">
            <span class="cs-card__detail__name">
              <h1>Red Alchemist</h1>
            </span>
            <div class="cs-card__detail__rate">
              <img src="https://i.imgur.com/OoOIyfX.png"/>
              <p>999 People score</p>
            </div>
            <div class="cs-card__detail__statistics">
              <div class="cs-card__detail__statistics-bag">
                <span>
                  <label>Type</label>
                  <p>Magic</p>
                </span>
                <img src="https://i.imgur.com/f8cvB9m.png"/>
              </div>
              <button id="cs-select-btn">SELECT</button>
            </div>
            <div class="cs-card__logo">
              <img src="https://static.wixstatic.com/media/71b9db_149c0db80b7d4643ab931f36710fd998~mv2.png/v1/fill/w_477,h_327,al_c,q_85,usm_0.66_1.00_0.01/71b9db_149c0db80b7d4643ab931f36710fd998~mv2.webp"/>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Supercell HUD -->
    <div id="sc-hud">
      <!-- Menu Button: Top Right of Screen -->
      <div class="sc-menu-btn" id="sc-menu-trigger">
        <img src="/assets/menu-icon.png" class="sc-menu-icon">
      </div>

        <!-- Character Video -->
        <div id="sc-character-container">
          <video id="sc-video-1" class="sc-video-layer active" muted playsinline></video>
          <video id="sc-video-2" class="sc-video-layer" muted playsinline></video>
        </div>

      <div class="sc-top-bar">
        <!-- Star Rating Bar -->
        <div class="sc-star-bar">
          <div class="sc-star" id="sc-star-1">
            <svg viewBox="0 0 32 32">
              <g transform="translate(16,16)">
                <circle class="sc-star-ring" fill="none" stroke-width="16" r="8" transform="scale(0)" />
              </g>
              <g stroke-linecap="round" stroke-linejoin="round">
                <g transform="translate(16,16) rotate(180)">
                  <polygon class="sc-star-stroke" points="0,15 4.41,6.07 14.27,4.64 7.13,-2.32 8.82,-12.14 0,-7.5 -8.82,-12.14 -7.13,-2.32 -14.27,4.64 -4.41,6.07" />
                  <polygon class="sc-star-fill" points="0,15 4.41,6.07 14.27,4.64 7.13,-2.32 8.82,-12.14 0,-7.5 -8.82,-12.14 -7.13,-2.32 -14.27,4.64 -4.41,6.07" />
                </g>
                <g transform="translate(16,16)" stroke-dasharray="12 12" stroke-dashoffset="12">
                  <polyline class="sc-star-line" transform="rotate(0)" points="0 4,0 16" />
                  <polyline class="sc-star-line" transform="rotate(72)" points="0 4,0 16" />
                  <polyline class="sc-star-line" transform="rotate(144)" points="0 4,0 16" />
                  <polyline class="sc-star-line" transform="rotate(216)" points="0 4,0 16" />
                  <polyline class="sc-star-line" transform="rotate(288)" points="0 4,0 16" />
                </g>
              </g>
            </svg>
          </div>
          
          <div class="sc-star-connector" id="sc-conn-1"></div>

          <div class="sc-star" id="sc-star-2">
            <svg viewBox="0 0 32 32">
              <g transform="translate(16,16)">
                <circle class="sc-star-ring" fill="none" stroke-width="16" r="8" transform="scale(0)" />
              </g>
              <g stroke-linecap="round" stroke-linejoin="round">
                <g transform="translate(16,16) rotate(180)">
                  <polygon class="sc-star-stroke" points="0,15 4.41,6.07 14.27,4.64 7.13,-2.32 8.82,-12.14 0,-7.5 -8.82,-12.14 -7.13,-2.32 -14.27,4.64 -4.41,6.07" />
                  <polygon class="sc-star-fill" points="0,15 4.41,6.07 14.27,4.64 7.13,-2.32 8.82,-12.14 0,-7.5 -8.82,-12.14 -7.13,-2.32 -14.27,4.64 -4.41,6.07" />
                </g>
                <g transform="translate(16,16)" stroke-dasharray="12 12" stroke-dashoffset="12">
                  <polyline class="sc-star-line" transform="rotate(0)" points="0 4,0 16" />
                  <polyline class="sc-star-line" transform="rotate(72)" points="0 4,0 16" />
                  <polyline class="sc-star-line" transform="rotate(144)" points="0 4,0 16" />
                  <polyline class="sc-star-line" transform="rotate(216)" points="0 4,0 16" />
                  <polyline class="sc-star-line" transform="rotate(288)" points="0 4,0 16" />
                </g>
              </g>
            </svg>
          </div>

          <div class="sc-star-connector" id="sc-conn-2"></div>

          <div class="sc-star" id="sc-star-3">
            <svg viewBox="0 0 32 32">
              <g transform="translate(16,16)">
                <circle class="sc-star-ring" fill="none" stroke-width="16" r="8" transform="scale(0)" />
              </g>
              <g stroke-linecap="round" stroke-linejoin="round">
                <g transform="translate(16,16) rotate(180)">
                  <polygon class="sc-star-stroke" points="0,15 4.41,6.07 14.27,4.64 7.13,-2.32 8.82,-12.14 0,-7.5 -8.82,-12.14 -7.13,-2.32 -14.27,4.64 -4.41,6.07" />
                  <polygon class="sc-star-fill" points="0,15 4.41,6.07 14.27,4.64 7.13,-2.32 8.82,-12.14 0,-7.5 -8.82,-12.14 -7.13,-2.32 -14.27,4.64 -4.41,6.07" />
                </g>
                <g transform="translate(16,16)" stroke-dasharray="12 12" stroke-dashoffset="12">
                  <polyline class="sc-star-line" transform="rotate(0)" points="0 4,0 16" />
                  <polyline class="sc-star-line" transform="rotate(72)" points="0 4,0 16" />
                  <polyline class="sc-star-line" transform="rotate(144)" points="0 4,0 16" />
                  <polyline class="sc-star-line" transform="rotate(216)" points="0 4,0 16" />
                  <polyline class="sc-star-line" transform="rotate(288)" points="0 4,0 16" />
                </g>
              </g>
            </svg>
          </div>
        </div>

        <!-- Score: Top Left -->
        <div class="sc-stat-box-score">
          <img src="/assets/score-icon.png" class="sc-stat-icon">
          <span class="sc-stat-text" id="sc-score-val">0</span>
        </div>
        <!-- Moves: Top Right -->
        <div class="sc-stat-box-moves">
          <img src="/assets/moves-icon.png" class="sc-stat-icon">
          <span class="sc-stat-text" id="sc-moves-val">30</span>
        </div>
      </div>
    </div>

    <!-- Win Screen Overlay -->
    <div id="sc-win-screen">
      <canvas id="sc-win-canvas"></canvas>
      <div class="sc-win-title">VICTORY!</div>
      <div class="sc-win-stars">
        <div class="sc-win-star" id="sc-win-star-1">
          <svg viewBox="0 0 32 32" style="width:100%; height:100%;">
            <g transform="translate(16,16)">
              <polygon fill="#f2b01e" stroke="#000" stroke-width="2" points="0,15 4.41,6.07 14.27,4.64 7.13,-2.32 8.82,-12.14 0,-7.5 -8.82,-12.14 -7.13,-2.32 -14.27,4.64 -4.41,6.07" />
            </g>
          </svg>
        </div>
        <div class="sc-win-star" id="sc-win-star-2">
          <svg viewBox="0 0 32 32" style="width:100%; height:100%;">
            <g transform="translate(16,16)">
              <polygon fill="#f2b01e" stroke="#000" stroke-width="2" points="0,15 4.41,6.07 14.27,4.64 7.13,-2.32 8.82,-12.14 0,-7.5 -8.82,-12.14 -7.13,-2.32 -14.27,4.64 -4.41,6.07" />
            </g>
          </svg>
        </div>
        <div class="sc-win-star" id="sc-win-star-3">
          <svg viewBox="0 0 32 32" style="width:100%; height:100%;">
            <g transform="translate(16,16)">
              <polygon fill="#f2b01e" stroke="#000" stroke-width="2" points="0,15 4.41,6.07 14.27,4.64 7.13,-2.32 8.82,-12.14 0,-7.5 -8.82,-12.14 -7.13,-2.32 -14.27,4.64 -4.41,6.07" />
            </g>
          </svg>
        </div>
      </div>
      <button class="sc-win-btn" onclick="window.restartGame()">PLAY AGAIN</button>
    </div>

    <!-- Pause Menu -->
    <div id="sc-pause-menu">
      <div class="sc-menu-panel">
        <div class="sc-menu-title">PAUSED</div>
        <div class="sc-menu-option btn-resume" onclick="window.togglePauseMenu()">RESUME</div>
        <div class="sc-menu-option" onclick="window.showConfirm('RESTART GAME?', () => { window.restartGame(); window.togglePauseMenu(); })">RESTART GAME</div>
        <div class="sc-menu-option" onclick="window.showConfirm('FORCE RESHUFFLE?', () => { if(window.forceReshuffle) window.forceReshuffle(); window.togglePauseMenu(); })">
            FORCE RESHUFFLE <i class="fa fa-refresh"></i>
        </div>
        <div class="sc-menu-option" id="btn-mute-music" onclick="window.toggleMusicMute()">MUTE MUSIC</div>
        <div class="sc-menu-option" id="btn-mute-sfx" onclick="window.toggleSfxMute()">MUTE SFX</div>
        <div class="sc-menu-option btn-quit" onclick="window.showConfirm('QUIT GAME?', () => location.reload())">QUIT</div>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="sc-confirm-modal">
        <div class="sc-confirm-box">
            <div class="sc-confirm-text" id="sc-confirm-msg">ARE YOU SURE?</div>
            <div class="sc-confirm-actions">
                <button class="sc-btn-yes" id="sc-confirm-yes">YES</button>
                <button class="sc-btn-no" onclick="document.getElementById('sc-confirm-modal').style.display='none'">NO</button>
            </div>
        </div>
    </div>

    <script>
      (function() {
        // --- CONFIG ---
        var USE_CIRCLE_VIDEO = true; // Set to true for circular character video, false for rectangular
        var USE_FAKE_LOADING = false; // Set to false to use real Pixi progress
        var FAKE_LOAD_DURATION = 5000; // 5 seconds
        
        // Apply Circle Mode if enabled
        if (USE_CIRCLE_VIDEO) {
            var vContainer = document.getElementById('sc-character-container');
            if (vContainer) vContainer.classList.add('sc-video-circle');
        }

        var targetProgress = 0;
        var visualProgress = 0;
        var animationRunning = false;
        var isHiding = false;
        var startTime = Date.now();

        var glow = document.getElementById('loaderGlow');
        var underglow = document.getElementById('loaderUnderglow');
        var loader = document.getElementById('appLoader');
        var muteBtn = document.getElementById('muteBtn');
        var initOverlay = document.getElementById('sc-init-overlay');
        var initBtn = document.getElementById('sc-init-btn');
        
        window.hasInteracted = false;

        // --- GLOBAL AUDIO UNLOCK ---
        window.unlockAudio = function() {
            var AudioContext = window.AudioContext || window.webkitAudioContext;
            if (AudioContext) {
                var ctx = new AudioContext();
                if (ctx.state === 'suspended') {
                    ctx.resume();
                }
                var buffer = ctx.createBuffer(1, 1, 22050);
                var source = ctx.createBufferSource();
                source.buffer = buffer;
                source.connect(ctx.destination);
                source.start(0);
            }
        };

        // --- Init Overlay Logic ---
        if (initBtn) {
            initBtn.addEventListener('click', function() {
                window.hasInteracted = true;
                
                // Unlock Audio
                if (window.unlockAudio) window.unlockAudio();

                if (window.playAudioEvent) window.playAudioEvent('init');
                if (initOverlay) initOverlay.style.display = 'none';
                
                // If loader was supposed to be showing, show it now
                if (loader && loader.dataset.shouldShow === 'true') {
                    loader.style.display = 'block';
                    loader.style.opacity = '1';
                }
            });
        }

        // --- Loader Logic ---
        window.showLoader = function(show) {
          if (!loader) return;
          
          if (show === false) {
            loader.style.opacity = '0';
            setTimeout(function() { loader.style.display = 'none'; }, 500);
            // Also hide init overlay if it's still there (fast load case)
            if (initOverlay) initOverlay.style.display = 'none';
            return;
          }

          // Mark as should show
          loader.dataset.shouldShow = 'true';

          // ALWAYS show loader immediately (removed init overlay dependency)
          loader.style.display = 'block';
          loader.style.opacity = '1';

          if (USE_FAKE_LOADING) {
            startTime = Date.now();
            if (!animationRunning) {
              animationRunning = true;
              requestAnimationFrame(updateLoader);
            }
          }
        };

        // --- PRELOADER ---
        window.preloadAssets = function(callback) {
            var assetsLoaded = 0;
            var totalAssets = 0;
            
            // 1. Videos to preload
            var videoList = [
                '/assets/video/artworx-alchemy-intro.mp4',
                '/assets/video/start-screen-loop-bg.mp4'
                // Add mascot videos here if you have their paths
            ];
            
            // 2. Audio to preload (Game Theme)
            var audioList = [
                '/assets/audio/music/match3-theme.mp3', // Example path, verify actual path
                '/assets/audio/sfx/match.mp3' // Example
            ];

            // We will just count videos for now as audio decoding is complex to track perfectly with simple XHR
            // But we can do it.
            
            totalAssets = videoList.length; 
            
            // Helper to update progress
            function checkProgress() {
                assetsLoaded++;
                // We can report this to the main loader if we want detailed sub-progress
                // For now, we just ensure they are ready before firing callback
                if (assetsLoaded >= totalAssets) {
                    if (callback) callback();
                }
            }

            if (totalAssets === 0) {
                if (callback) callback();
                return;
            }

            // Load Videos
            videoList.forEach(function(src) {
                var vid = document.createElement('video');
                vid.src = src;
                vid.preload = 'auto';
                vid.muted = true;
                vid.playsInline = true;
                // Fix: Do not use display: none, as it can prevent playback on some mobile browsers
                vid.style.position = 'absolute';
                vid.style.top = '-9999px';
                vid.style.opacity = '0';
                vid.style.pointerEvents = 'none';
                document.body.appendChild(vid);
                
                // We consider it "loaded" enough when it can play through or has enough data
                vid.oncanplaythrough = function() {
                    // Store reference globally so we can reuse it
                    if (!window.preloadedVideos) window.preloadedVideos = {};
                    window.preloadedVideos[src] = vid;
                    
                    // Remove listener to avoid double counting
                    vid.oncanplaythrough = null;
                    checkProgress();
                };
                
                vid.onerror = function() {
                    console.warn("Failed to preload video:", src);
                    checkProgress(); // Proceed anyway
                };
                
                vid.load();
            });
        };

        window.setLoadingProgress = function(p) {
          if (!USE_FAKE_LOADING) {
            targetProgress = Math.min(1, Math.max(0, p));
            if (!animationRunning) {
              animationRunning = true;
              requestAnimationFrame(updateLoader);
            }
          }
        };

        function updateLoader() {
          if (USE_FAKE_LOADING) {
            var elapsed = Date.now() - startTime;
            targetProgress = Math.min(1, elapsed / FAKE_LOAD_DURATION);
          }

          visualProgress += (targetProgress - visualProgress) * 0.12;
          
          if (targetProgress >= 0.99 && Math.abs(targetProgress - visualProgress) < 0.001) {
            visualProgress = 1;
          }

          var pct = (visualProgress * 100).toFixed(2) + "%";
          if (glow) glow.style.width = pct;
          if (underglow) underglow.style.width = pct;

          if (visualProgress >= 0.999 && !isHiding) {
            isHiding = true;
            setTimeout(function() {
              if (loader) {
                loader.style.opacity = '0';
                setTimeout(function() {
                  loader.style.display = 'none';
                  // Fix: Ensure loader doesn't pop back up if initBtn is clicked later
                  loader.dataset.shouldShow = 'false';
                  // Fix: Remove init overlay if it's still there, so user sees "Click to Start"
                  if (initOverlay) initOverlay.style.display = 'none';

                  // Dispatch event to Pixi that loading is DONE
                  window.dispatchEvent(new CustomEvent('loadingComplete'));
                }, 500);
              }
            }, 200);
          }

          if (visualProgress < 0.999 || !isHiding) {
            requestAnimationFrame(updateLoader);
          } else {
            animationRunning = false;
          }
        }

        // --- Mute Button Logic ---
        window.showMuteButton = function(show) {
          if (muteBtn) muteBtn.style.display = show ? 'block' : 'none';
        };

        window.updateMuteButtonPosition = function(x, y, isDesktop) {
          if (!muteBtn) return;
          if (isDesktop) {
            muteBtn.style.top = y + 'px';
            muteBtn.style.left = x + 'px';
            muteBtn.style.right = 'auto';
            muteBtn.style.bottom = 'auto';
          } else {
            // Mobile uses CSS fixed position
            muteBtn.style.top = '';
            muteBtn.style.left = '';
            muteBtn.style.right = '';
            muteBtn.style.bottom = '';
          }
        };

        window.setMuteState = function(isMuted) {
          if (muteBtn) {
            if (isMuted) muteBtn.classList.add('sound-mute');
            else muteBtn.classList.remove('sound-mute');
          }
        };

        // --- HUD & PAUSE LOGIC ---
        var hud = document.getElementById('sc-hud');
        var scoreVal = document.getElementById('sc-score-val');
        var movesVal = document.getElementById('sc-moves-val');
        var pauseMenu = document.getElementById('sc-pause-menu');
        var menuBtn = document.getElementById('sc-menu-trigger');
        var isPaused = false;

        window.showHUD = function(show) {
          if (hud) hud.style.display = show ? 'block' : 'none';
          
          // Start Character Video Sequence when HUD is shown (Game Start)
          if (show && window.resetCharacterVideo) {
             window.resetCharacterVideo();
          }
        };

        window.updateHUD = function(score, moves) {
          if (scoreVal) scoreVal.innerText = score;
          if (movesVal) movesVal.innerText = moves;
          if (window.updateStarRating) window.updateStarRating(score);
        };

        window.punchScoreHUD = function() {
          var scoreBox = document.querySelector('.sc-stat-box-score');
          if (scoreBox) {
            var isMobile = window.innerWidth <= 768;
            var normalScale = isMobile ? 1.0 : 2.0;
            var punchScale = isMobile ? 1.1 : 2.2;

            // Reset animation
            scoreBox.style.transition = 'none';
            scoreBox.style.transform = 'skewX(-9deg) scale(' + punchScale + ')'; // Punch up
            
            // Force reflow
            void scoreBox.offsetWidth;

            // Animate back
            setTimeout(function() {
              scoreBox.style.transition = 'transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
              scoreBox.style.transform = 'skewX(-9deg) scale(' + normalScale + ')'; // Back to normal
            }, 50);
          }
        };

        window.getScorePosition = function() {
          var scoreBox = document.querySelector('.sc-stat-box-score');
          if (scoreBox) {
            var rect = scoreBox.getBoundingClientRect();
            return {
              x: rect.left + rect.width / 2,
              y: rect.top + rect.height / 2
            };
          }
          return { x: 0, y: 0 };
        };

        window.updateHUDLayout = function(x, y, width, scale) {
          var topBar = document.querySelector('.sc-top-bar');
          if (topBar) {
            topBar.style.left = x + 'px';
            topBar.style.top = y + 'px';
            topBar.style.width = width + 'px';
            // We do NOT scale the container, as that messes up the corner anchoring.
            // Instead, we scale the individual boxes via CSS.
          }
        };

        window.togglePauseMenu = function() {
          isPaused = !isPaused;
          if (pauseMenu) pauseMenu.style.display = isPaused ? 'flex' : 'none';
        };

        if (menuBtn) {
          menuBtn.addEventListener('click', function() {
            window.togglePauseMenu();
          });
        }

        // Global ESC listener for Pause (only if HUD is visible/Game Active)
        window.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            // If HUD is visible, we are in game
            if (hud && hud.style.display === 'block') {
              window.togglePauseMenu();
            }
          }
        });

        if (muteBtn) {
          muteBtn.addEventListener('click', function() {
            // Toggle visual state immediately
            var isMuted = muteBtn.classList.contains('sound-mute');
            // If currently muted, we want to unmute (remove class)
            // If currently unmuted, we want to mute (add class)
            // But the game logic drives this. We should dispatch an event or call a global callback.
            // For simplicity, let's dispatch a custom event on window
            var event = new CustomEvent('toggleMute', { detail: { muted: !isMuted } });
            window.dispatchEvent(event);
          });
        }
      })();
    </script>
    <script type="module" src="/src/main.ts"></script>
    <!-- Star Rating Logic -->
    <script>
      window.currentStarLevel = 0;
      window.hasWon = false;

      window.updateStarRating = function(score) {
        const star1 = document.getElementById('sc-star-1');
        const star2 = document.getElementById('sc-star-2');
        const star3 = document.getElementById('sc-star-3');
        const conn1 = document.getElementById('sc-conn-1');
        const conn2 = document.getElementById('sc-conn-2');

        // Reset if score is 0 (New Game)
        if (score === 0) {
            window.currentStarLevel = 0;
            window.hasWon = false;
            if (star1) star1.classList.remove('active');
            if (star2) star2.classList.remove('active');
            if (star3) star3.classList.remove('active');
            if (conn1) conn1.classList.remove('active');
            if (conn2) conn2.classList.remove('active');
            document.getElementById('sc-win-screen').style.display = 'none';
            return;
        }

        if (window.hasWon) return;

        // Thresholds: 1 star per 250pts
        if (score >= 250 && window.currentStarLevel < 1) {
          if (star1) star1.classList.add('active');
          window.currentStarLevel = 1;
          if (window.playAudioEvent) window.playAudioEvent('star_1');
        }
        if (score >= 500 && window.currentStarLevel < 2) {
          if (star2) star2.classList.add('active');
          if (conn1) conn1.classList.add('active'); // Connect 1 & 2
          window.currentStarLevel = 2;
          if (window.playAudioEvent) window.playAudioEvent('star_2');
        }
        if (score >= 750 && window.currentStarLevel < 3) {
          if (star3) star3.classList.add('active');
          if (conn2) conn2.classList.add('active'); // Connect 2 & 3
          window.currentStarLevel = 3;
          if (window.playAudioEvent) window.playAudioEvent('star_3');
          
          // Trigger Win
          window.hasWon = true;
          
          // Lock Input
          if (window.lockGameInput) window.lockGameInput();

          setTimeout(() => {
            if (window.playAudioEvent) window.playAudioEvent('win');
            const winScreen = document.getElementById('sc-win-screen');
            winScreen.style.display = 'flex';
            
            // Start Fireworks
            if (window.startFireworks) window.startFireworks();
            
            // Animate Win Stars sequentially (Slower: 0.5s intervals)
            setTimeout(() => document.getElementById('sc-win-star-1').classList.add('pop'), 500);
            setTimeout(() => document.getElementById('sc-win-star-2').classList.add('pop'), 1000);
            setTimeout(() => document.getElementById('sc-win-star-3').classList.add('pop'), 1500);
          }, 800); 
        }
      };

      window.restartGame = function() {
        if (window.resetGame) {
            window.resetGame();
            document.getElementById('sc-win-screen').style.display = 'none';
            // Reset Win Stars
            document.querySelectorAll('.sc-win-star').forEach(el => el.classList.remove('pop'));
            // Stop Fireworks
            if (window.stopFireworks) window.stopFireworks();
            // Reset Character Video
            if (window.resetCharacterVideo) window.resetCharacterVideo();
            // Restart Audio
            if (window.playAudioEvent) window.playAudioEvent('game_start');
        } else {
            location.reload();
        }
      };



      // --- CHARACTER VIDEO LOGIC ---
      (function() {
        const video1 = document.getElementById('sc-video-1');
        const video2 = document.getElementById('sc-video-2');
        let activeVideo = video1;
        
        const ASSETS = {
            intro: '/assets/video/red-hey.mp4',
            idle: '/assets/video/red-idle.mp4',
            random: [
                '/assets/video/red-spin.mp4',
                '/assets/video/red-toblue.mp4'
            ]
        };
        
        let idleLoopCount = 0;
        let targetIdleLoops = 1;
        let sequenceIndex = 0;

        function playVideo(url, loop, onEnded) {
            if (!video1 || !video2) return;
            
            const nextVideo = (activeVideo === video1) ? video2 : video1;
            const prevVideo = activeVideo;

            nextVideo.src = url;
            nextVideo.loop = loop;
            nextVideo.currentTime = 0;
            
            let endedTriggered = false;
            const triggerEnded = () => {
                if (endedTriggered) return;
                endedTriggered = true;
                if (onEnded) onEnded();
            };

            nextVideo.onended = triggerEnded;

            // Seamless Transition: Monitor for "1 frame before end"
            if (!loop && onEnded) {
                const monitor = () => {
                    if (activeVideo === nextVideo && !endedTriggered) {
                        if (nextVideo.duration > 0 && nextVideo.currentTime >= nextVideo.duration - 0.04) {
                            triggerEnded();
                        } else {
                            requestAnimationFrame(monitor);
                        }
                    }
                };
                requestAnimationFrame(monitor);
            }

            nextVideo.play().then(() => {
                // Place next video ON TOP immediately
                nextVideo.style.zIndex = "3";
                prevVideo.style.zIndex = "2";
                nextVideo.classList.add('active');
                activeVideo = nextVideo;
                
                // Wait 2ms after it has started playing, then remove the old one
                setTimeout(() => {
                    if (activeVideo === nextVideo) {
                        prevVideo.classList.remove('active');
                        prevVideo.pause();
                        prevVideo.style.zIndex = ""; // Reset z-index
                    }
                }, 2);
            }).catch(e => console.log("Video play failed:", e));
        }

        function startIdleLoop() {
            // Play Idle once (loop=false) to catch onended
            playVideo(ASSETS.idle, false, () => {
                idleLoopCount++;
                if (idleLoopCount >= targetIdleLoops) {
                    idleLoopCount = 0;
                    targetIdleLoops = Math.floor(Math.random() * 2) + 1; // Randomly 1 or 2 loops
                    playRandomAnimation();
                } else {
                    startIdleLoop();
                }
            });
        }

        function playRandomAnimation() {
            let randUrl;
            // Sequence: Spin -> ToBlue -> Random
            if (sequenceIndex === 0) {
                randUrl = ASSETS.random[0];
                sequenceIndex++;
            } else if (sequenceIndex === 1) {
                randUrl = ASSETS.random[1];
                sequenceIndex++;
            } else {
                randUrl = ASSETS.random[Math.floor(Math.random() * ASSETS.random.length)];
            }

            playVideo(randUrl, false, () => {
                startIdleLoop();
            });
        }

        window.resetCharacterVideo = function() {
            if (!video1 || !video2) return;
            idleLoopCount = 0;
            targetIdleLoops = Math.floor(Math.random() * 2) + 1;
            sequenceIndex = 0;

            activeVideo = video1;
            video1.classList.add('active');
            video2.classList.remove('active');
            
            video1.src = ASSETS.intro;
            video1.loop = false;
            video1.pause();
            video1.currentTime = 0;

            // Audio: Duck BGM
            if (window.playAudioEvent) window.playAudioEvent('intro_start');

            setTimeout(() => {
                video1.play().then(() => {
                    // Audio: Door Open
                    if (window.playAudioEvent) window.playAudioEvent('video_door');
                    
                    // Audio: Red Hi (2s before end)
                    const hiTime = (video1.duration - 2) * 1000;
                    if (hiTime > 0) {
                        setTimeout(() => {
                            if (window.playAudioEvent) window.playAudioEvent('video_hi');
                        }, hiTime);
                    }
                }).catch(e => console.log("Intro play failed:", e));

                video1.onended = () => {
                    // Audio: Restore BGM
                    if (window.playAudioEvent) window.playAudioEvent('intro_end');
                    startIdleLoop();
                };
            }, 2000);
        };

      })();

      // --- AUDIO MANAGER ---
      (function() {
        const AUDIO = {
            bgmMain: new Audio('/assets/audio/artworx-alchemy-maintheme.mp3'),
            bgmGame: [
                new Audio('/assets/audio/game-theme-1.mp3'),
                new Audio('/assets/audio/game-theme-2.mp3')
            ],
            sfx: {
                start: new Audio('/assets/audio/start.mp3'),
                select: [
                    new Audio('/assets/audio/select-red-1.mp3'),
                    new Audio('/assets/audio/select-red-2.mp3')
                ],
                doorOpen: new Audio('/assets/audio/door-open.mp3'),
                redHi: new Audio('/assets/audio/red-hi-2.mp3'),
                brush: new Audio('/assets/audio/brush-1.mp3'),
                swap: [
                    new Audio('/assets/audio/gem-swap-1.mp3'),
                    new Audio('/assets/audio/gem-swap-2.mp3'),
                    new Audio('/assets/audio/gem-swap-3.mp3'),
                    new Audio('/assets/audio/gem-swap-4.mp3')
                ],
                pop: [
                    new Audio('/assets/audio/gem-pop-1.mp3'),
                    new Audio('/assets/audio/gem-pop-2.mp3'),
                    new Audio('/assets/audio/gem-pop-3.mp3'),
                    new Audio('/assets/audio/gem-pop-4.mp3')
                ],
                star1: new Audio('/assets/audio/get_star_1.mp3'),
                star2: new Audio('/assets/audio/get_star_2.mp3'),
                victory: new Audio('/assets/audio/victory.mp3'),
                chrimes: new Audio('/assets/audio/chrimes.mp3')
            }
        };

        // Preload Audio for Mobile
        AUDIO.bgmMain.preload = 'auto';
        AUDIO.bgmGame.forEach(a => a.preload = 'auto');
        Object.values(AUDIO.sfx).forEach(s => {
            if (Array.isArray(s)) s.forEach(a => a.preload = 'auto');
            else s.preload = 'auto';
        });

        AUDIO.bgmMain.loop = true;
        AUDIO.bgmGame.forEach(a => a.loop = true);

        let currentBGM = null;
        let isMuted = false; // Global mute (deprecated/video only)
        let isMusicMuted = false;
        let isSfxMuted = false;

        function playSfx(key, index = -1) {
            if (isSfxMuted) return;
            let sound;
            if (Array.isArray(AUDIO.sfx[key])) {
                sound = (index >= 0) ? AUDIO.sfx[key][index] : AUDIO.sfx[key][Math.floor(Math.random() * AUDIO.sfx[key].length)];
            } else {
                sound = AUDIO.sfx[key];
            }
            if (sound) {
                sound.currentTime = 0;
                sound.play().catch(e => {});
            }
        }

        window.toggleMusicMute = function() {
            isMusicMuted = !isMusicMuted;
            const btn = document.getElementById('btn-mute-music');
            if (btn) {
                btn.innerText = isMusicMuted ? "UNMUTE MUSIC" : "MUTE MUSIC";
                if (isMusicMuted) btn.classList.add('grey');
                else btn.classList.remove('grey');
            }
            
            if (currentBGM) {
                currentBGM.muted = isMusicMuted;
            }
            AUDIO.bgmMain.muted = isMusicMuted;
            AUDIO.bgmGame.forEach(a => a.muted = isMusicMuted);
        };

        window.toggleSfxMute = function() {
            isSfxMuted = !isSfxMuted;
            const btn = document.getElementById('btn-mute-sfx');
            if (btn) {
                btn.innerText = isSfxMuted ? "UNMUTE SFX" : "MUTE SFX";
                if (isSfxMuted) btn.classList.add('grey');
                else btn.classList.remove('grey');
            }
        };

        // --- CONFIRMATION MODAL ---
        window.showConfirm = function(msg, callback) {
            const modal = document.getElementById('sc-confirm-modal');
            const txt = document.getElementById('sc-confirm-msg');
            const yesBtn = document.getElementById('sc-confirm-yes');
            
            if (modal && txt && yesBtn) {
                txt.innerText = msg;
                // Remove old listener
                const newYes = yesBtn.cloneNode(true);
                yesBtn.parentNode.replaceChild(newYes, yesBtn);
                
                newYes.addEventListener('click', () => {
                    modal.style.display = 'none';
                    if (callback) callback();
                });
                
                modal.style.display = 'flex';
            }
        };

        window.playAudioEvent = function(event) {
            switch(event) {
                case 'init': // Called on first user interaction
                    if (!currentBGM) {
                        currentBGM = AUDIO.bgmMain;
                        currentBGM.volume = 1.0;
                    }
                    // Always try to play if paused, even if we set it before
                    if (!isMusicMuted && currentBGM.paused) {
                        currentBGM.play().catch(e => console.log("Autoplay blocked", e));
                    }
                    break;
                case 'intro_start':
                    if (currentBGM) {
                        // Ensure it's playing (fix for mobile pausing BGM when video starts)
                        if (currentBGM.paused && !isMusicMuted) {
                            currentBGM.play().catch(e => {});
                        }
                        
                        // Ease down to 50%
                        let vol = currentBGM.volume;
                        const fade = setInterval(() => {
                            if (vol > 0.5) {
                                vol -= 0.05;
                                currentBGM.volume = Math.max(0.5, vol);
                            } else {
                                clearInterval(fade);
                            }
                        }, 50);
                    }
                    playSfx('start'); 
                    break;
                case 'intro_end':
                    if (currentBGM) {
                        // Ease up to 90%
                        let vol = currentBGM.volume;
                        const fade = setInterval(() => {
                            if (vol < 0.9) {
                                vol += 0.05;
                                currentBGM.volume = Math.min(0.9, vol);
                            } else {
                                clearInterval(fade);
                            }
                        }, 50);
                    }
                    break;
                case 'start_button_click':
                    playSfx('start');
                    break;
                case 'character_select':
                    playSfx('select');
                    break;
                case 'game_start':
                    if (currentBGM) {
                        currentBGM.pause();
                        currentBGM.currentTime = 0;
                    }
                    currentBGM = AUDIO.bgmGame[Math.floor(Math.random() * AUDIO.bgmGame.length)];
                    currentBGM.volume = 0.6;
                    currentBGM.muted = isMusicMuted; // Apply current mute state
                    if (!isMusicMuted) currentBGM.play();
                    else currentBGM.play(); // Play anyway so unmuting works, just muted
                    break;
                case 'video_door':
                    playSfx('doorOpen');
                    break;
                case 'video_hi':
                    playSfx('redHi');
                    break;
                case 'swap':
                    playSfx('swap');
                    break;
                case 'preview_move':
                    playSfx('brush');
                    break;
                case 'match':
                    playSfx('pop');
                    break;
                case 'combo_4':
                    playSfx('chrimes');
                    break;
                case 'star_1':
                case 'star_2':
                    playSfx('star1');
                    break;
                case 'star_3':
                    playSfx('star2');
                    break;
                case 'win':
                    if (currentBGM) currentBGM.pause();
                    playSfx('victory');
                    break;
            }
        };

        // Mute Listener
        window.addEventListener('toggleMute', (e) => {
            // The mute button is ONLY for the intro video.
            // We do NOT mute the BGM or SFX here.
            // isMuted = e.detail.muted; 
            // if (currentBGM) {
            //     if (isMuted) currentBGM.pause();
            //     else currentBGM.play();
            // }
        });

        // Hook into Select Button
        const selectBtn = document.getElementById('cs-select-btn');
        if (selectBtn) {
            selectBtn.addEventListener('click', () => {
                window.playAudioEvent('character_select');
            });
        }
      })();

      // --- FIREWORKS LOGIC ---
      (function() {
        const canvas = document.getElementById('sc-win-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        let animationId = null;

        function resize() {
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        class Particle {
          constructor(x, y, color) {
            this.x = x;
            this.y = y;
            this.color = color;
            this.velocity = {
              x: (Math.random() - 0.5) * 12,
              y: (Math.random() - 0.5) * 12
            };
            this.alpha = 1;
            this.friction = 0.96;
            this.gravity = 0.15;
          }
          draw() {
            ctx.save();
            ctx.globalAlpha = this.alpha;
            ctx.beginPath();
            ctx.arc(this.x, this.y, 3, 0, Math.PI * 2);
            ctx.fillStyle = this.color;
            ctx.fill();
            ctx.restore();
          }
          update() {
            this.velocity.x *= this.friction;
            this.velocity.y *= this.friction;
            this.velocity.y += this.gravity;
            this.x += this.velocity.x;
            this.y += this.velocity.y;
            this.alpha -= 0.01;
          }
        }

        function createFirework(x, y) {
          const colors = ['#ff0043', '#14fc56', '#1e7fff', '#e60aff', '#ffbf36', '#ffffff'];
          const color = colors[Math.floor(Math.random() * colors.length)];
          for (let i = 0; i < 50; i++) {
            particles.push(new Particle(x, y, color));
          }
        }

        function animate() {
          animationId = requestAnimationFrame(animate);
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          
          particles.forEach((p, i) => {
            if (p.alpha > 0) {
              p.update();
              p.draw();
            } else {
              particles.splice(i, 1);
            }
          });

          if (Math.random() < 0.08) {
            createFirework(Math.random() * canvas.width, Math.random() * canvas.height * 0.6);
          }
        }

        window.startFireworks = function() {
          if (!animationId) animate();
        };

        window.stopFireworks = function() {
          cancelAnimationFrame(animationId);
          animationId = null;
          particles = [];
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        };
      })();
    </script>
  </body>
</html>
